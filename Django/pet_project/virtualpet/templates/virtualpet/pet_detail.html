<!DOCTYPE html>
<html>
<head>
    {% load static %}

    <meta charset="UTF-8">
    <title>{{ pet.name }}</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
        }
        .pet-image {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            display: block;
        }
        .status-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .status-box {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
            width: 150px;
        }
        .status-bar {
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        .hunger-bar {
            height: 100%;
            background-color: #4CAF50;
            width: {{ hunger_percent }}%;
        }
        .happiness-bar {
            height: 100%;
            background-color: #2196F3;
            width: {{ happiness_percent }}%;
        }
        .health-bar {
            height: 100%;
            background-color: #FF9800;
            width: {{ health_percent }}%;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .action-button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            width: 100px;
        }
        .action-button:hover {
            background-color: #45a049;
        }
        .action-button.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            pointer-events: none;
        }
        .info {
            margin-top: 30px;
            font-size: 18px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ pet.name }}</h1>
        
        <img id="pet-image" class="pet-image" src="{% static 'img/pet1.gif' %}" alt="宠物小猫">
        
        <div class="status-container">
            <div class="status-box">
                <div>饱食度</div>
                <div class="status-bar"><div class="hunger-bar"></div></div>
                <div class="hunger-text">{{ hunger_percent|floatformat:1 }}%</div>
            </div>
            <div class="status-box">
                <div>愉悦度</div>
                <div class="status-bar"><div class="happiness-bar"></div></div>
                <div class="happiness-text">{{ happiness_percent|floatformat:1 }}%</div>
            </div>
            <div class="status-box">
                <div>健康度</div>
                <div class="status-bar"><div class="health-bar"></div></div>
                <div class="health-text">{{ health_percent|floatformat:1 }}%</div>
            </div>
        </div>
        
        <div class="info">
            <p>成长天数: {{ pet.growth }}</p>
            <p>年龄: {{ pet.year }}岁</p>
            <p>状态: {% if status == 'sleeping' %}睡觉{% else %}清醒{% endif %}</p>
        </div>
        
        <div class="action-buttons">
            <button id="feed-btn" class="action-button">喂食</button>
            <button id="walk-btn" class="action-button">散步</button>
            <button id="play-btn" class="action-button">玩耍</button>
            <button id="doctor-btn" class="action-button">寻医</button>
        </div>
        <div id="message" style="margin-top: 20px; color: red;"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 操作按钮点击事件和冷却管理
        $(document).ready(function() {
            // 存储按钮冷却状态
            var buttonCooldowns = {
                'feed-btn': 0,
                'walk-btn': 0,
                'play-btn': 0,
                'doctor-btn': 0
            };
            
            
            // 更新按钮状态函数

            // 更新按钮状态函数
            function updateButtonStates() {
                var now = Date.now();
                for (var btnId in buttonCooldowns) {
                    if (buttonCooldowns[btnId] > now) {
                        $('#' + btnId).addClass('disabled');
                    } else {
                        $('#' + btnId).removeClass('disabled');
                    }
                }
            }

            // 定期检查按钮冷却状态
            setInterval(updateButtonStates, 100);
            // 喂食按钮
            $('#feed-btn').click(function() {
                $.get('{% url 'feed_pet' %}', function(data) {
                    if (data.status === 'error') {
                        $('#message').text(data.message).show();
                        setTimeout(function() {
                            $('#message').hide();
                        }, 3000);
                        // 解析剩余时间并设置按钮冷却
                        var remainingMatch = data.message.match(/还需(\d+)秒/);
                        if (remainingMatch) {
                            var remainingSeconds = parseInt(remainingMatch[1]);
                            buttonCooldowns['feed-btn'] = Date.now() + remainingSeconds * 1000;
                        }
                    } else {
                        updatePetStatus();
                        // 设置按钮冷却时间 (2秒)
                        buttonCooldowns['feed-btn'] = Date.now() + 2000;
                    }
                }).fail(function() {
                    $('#message').text('操作失败，请重试').show();
                    setTimeout(function() {
                        $('#message').hide();
                    }, 3000);
                });
            });

            // 散步按钮
            $('#walk-btn').click(function() {
                $.get('{% url 'walk_pet' %}', function(data) {
                    if (data.status === 'error') {
                        $('#message').text(data.message).show();
                        setTimeout(function() {
                            $('#message').hide();
                        }, 3000);
                        // 解析剩余时间并设置按钮冷却
                        var remainingMatch = data.message.match(/还需(\d+)秒/);
                        if (remainingMatch) {
                            var remainingSeconds = parseInt(remainingMatch[1]);
                            buttonCooldowns['walk-btn'] = Date.now() + remainingSeconds * 1000;
                        }
                    } else {
                        updatePetStatus();
                        // 设置按钮冷却时间 (5秒)
                        buttonCooldowns['walk-btn'] = Date.now() + 5000;
                    }
                }).fail(function() {
                    $('#message').text('操作失败，请重试').show();
                    setTimeout(function() {
                        $('#message').hide();
                    }, 3000);
                });
            });

            // 玩耍按钮
            $('#play-btn').click(function() {
                $.get('{% url 'play_pet' %}', function(data) {
                    if (data.status === 'error') {
                        $('#message').text(data.message).show();
                        setTimeout(function() {
                            $('#message').hide();
                        }, 3000);
                        // 解析剩余时间并设置按钮冷却
                        var remainingMatch = data.message.match(/还需(\d+)秒/);
                        if (remainingMatch) {
                            var remainingSeconds = parseInt(remainingMatch[1]);
                            buttonCooldowns['play-btn'] = Date.now() + remainingSeconds * 1000;
                        }
                    } else {
                        updatePetStatus();
                        // 设置按钮冷却时间 (4秒)
                        buttonCooldowns['play-btn'] = Date.now() + 4000;
                    }
                }).fail(function() {
                    $('#message').text('操作失败，请重试').show();
                    setTimeout(function() {
                        $('#message').hide();
                    }, 3000);
                });
            });

            // 寻医按钮
            $('#doctor-btn').click(function() {
                $.get('{% url 'doctor_pet' %}', function(data) {
                    if (data.status === 'error') {
                        $('#message').text(data.message).show();
                        setTimeout(function() {
                            $('#message').hide();
                        }, 3000);
                        // 解析剩余时间并设置按钮冷却
                        var remainingMatch = data.message.match(/还需(\d+)秒/);
                        if (remainingMatch) {
                            var remainingSeconds = parseInt(remainingMatch[1]);
                            buttonCooldowns['doctor-btn'] = Date.now() + remainingSeconds * 1000;
                        }
                    } else {
                        updatePetStatus();
                        // 设置按钮冷却时间 (7秒)
                        buttonCooldowns['doctor-btn'] = Date.now() + 7000;
                    }
                }).fail(function() {
                    $('#message').text('操作失败，请重试').show();
                    setTimeout(function() {
                        $('#message').hide();
                    }, 3000);
                });
            });
        });
        // 图片动画效果
        var currentImageIndex = 1;
        var status = '{{ status }}';
        var imagePrefix = 'pet';
        
        // 根据宠物状态选择不同的图片序列
        if (status === 'sleeping') {
            imagePrefix = 'sleep';
        }
        
        function updatePetImage() {
            // 根据状态更新图片前缀
            $.get('{% url 'pet_detail' %}', function(data) {
                try {
                    // 查找状态文本
                    var statusText = $(data).find('.info p:nth-child(3)').text();
                    var newStatus = statusText.split(':')[1].trim();
                    if (newStatus !== status) {
                        status = newStatus;
                        imagePrefix = status === '睡觉' ? 'sleep' : 'pet';
                        currentImageIndex = 1;
                    }
                } catch (error) {
                    console.log('更新状态时出错:', error);
                }
            });
            
            // 更新图片
            var imagePath = '{% static 'img/' %}' + imagePrefix + currentImageIndex + '.gif';
            $('#pet-image').attr('src', imagePath);
            
            // 更新索引
            currentImageIndex++;
            
            // 根据不同状态设置不同的图片数量
            var maxImages = (imagePrefix === 'sleep') ? 7 : 14;
            if (currentImageIndex > maxImages) {
                currentImageIndex = 1;
            }
        }
        
        // 定期更新宠物图片
        setInterval(updatePetImage, 500);
        
        // 定期更新宠物状态
        // 添加更新计数器
        let updateCounter = 0;
        
        function updatePetStatus() {
            updateCounter++;
            console.log(`【状态更新函数】开始执行 (第${updateCounter}次更新)`);
            // 添加时间戳防止缓存
            const timestamp = new Date().getTime();
            const url = `/update_status/?_=${timestamp}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('【状态更新函数】请求成功，返回数据:', data);
                    if (data.status === 'success') {
                        console.log('【状态更新函数】数据验证成功，开始更新UI');
                        // 更新状态条
                        $('.hunger-bar').width(data.hunger_percent + '%');
                        $('.happiness-bar').width(data.happiness_percent + '%');
                        $('.health-bar').width(data.health_percent + '%');
                            
                        // 更新状态文本
                        $('.hunger-text').text((8 - data.hunger) + '/8 (' + data.hunger_percent.toFixed(1) + '%)');
                        $('.happiness-text').text(data.happiness + '/8 (' + data.happiness_percent.toFixed(1) + '%)');
                        $('.health-text').text(data.health + '/8 (' + data.health_percent.toFixed(1) + '%)');
                            
                        // 更新宠物信息
                        $('.info p:nth-child(1)').text('成长天数: ' + data.growth);
                        $('.info p:nth-child(2)').text('年龄: ' + data.year + '岁');
                        $('.info p:nth-child(3)').text('状态: ' + (data.pet_status === 'sleeping' ? '睡觉' : '清醒'));
                            
                        // 更新宠物状态（动画）
                        if (data.pet_status === 'sleeping' && imagePrefix !== 'sleep') {
                            imagePrefix = 'sleep';
                            currentImageIndex = 1;
                        } else if (data.pet_status !== 'sleeping' && imagePrefix === 'sleep') {
                            imagePrefix = 'pet';
                            currentImageIndex = 1;
                        }
                    }
                })
                .catch(error => {
                    console.log('【状态更新函数】请求失败:', error);
                    $('#message').text('更新状态失败，请重试').show();
                    setTimeout(function() {
                        $('#message').hide();
                    }, 3000);
                });
        }

        // 页面加载完成后执行
        $(document).ready(function() {
            console.log('【页面加载完成】准备设置状态更新定时器');
            
            // 使用递归的setTimeout代替setInterval
            function scheduleNextUpdate() {
                console.log('【定时器】安排下一次状态更新，5秒后执行');
                setTimeout(function() {
                    console.log('【定时器】触发，开始更新宠物状态');
                    updatePetStatus();
                    // 状态更新完成后，安排下一次更新
                    scheduleNextUpdate();
                }, 5000);
            }
            
            // 立即执行一次，避免首次等待
            console.log('【初始化】立即执行一次状态更新');
            updatePetStatus();
            
            // 安排下一次更新
            console.log('【初始化】安排首次定时更新');
            scheduleNextUpdate();
        });
    </script>
</body>
</html>